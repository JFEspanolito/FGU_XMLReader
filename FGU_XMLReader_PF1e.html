<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>FGU Character Editor - Pathfinder 1e</title>
    <style>
        /* Estilos de los botones de pestañas */
        .tab-button {
            background-color: #808080;
            color: black;
            border: 2px solid #333;
            border-radius: 5px 5px 0 0;
            padding: 6px 12px;
            margin-right: 4px;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .tab-button.active {
            background-color: #808080;
            color: white;
        }

        .tab-button:hover {
            filter: brightness(1.2);
        }

        /* Centrar texto en todos los input y textarea */
        input,
        textarea {
            text-align: center;
        }

        /* Centra cualquier <table> dentro del contenedor de Vista */
        [id^="vista"] table {
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <!-- Título principal -->
    <h1 style="text-align: center; width: 100%;">Editor de XML para Pathfinder 1e de FGU</h1>

    <!-- Zona de import/export de XML -->
    <div style="display: flex; justify-content: space-between; max-width: 600px; margin: 0 auto;">
        <!-- Botón para cargar archivo -->
        <div>
            <button onclick="document.getElementById('fileInput').click()">Importar XML</button>
            <input type="file" id="fileInput" accept=".xml" style="display:none" onchange="importarXML()">
        </div>
        <!-- Nombre del archivo actualmente cargado -->
        <div>
            <div id="nombreArchivoXML"></div>
        </div>
        <!-- Botón para descargar XML modificado -->
        <div><button onclick="exportarXML()">Exportar XML</button></div>
    </div>

    <!-- Pestañas de navegación (inicialmente ocultas) -->
    <div id="tabPanel" style="margin-top:20px; display:none; text-align:center;">
        <button class="tab-button" onclick="mostrarVistaMain(this)">Main</button>
        <button class="tab-button" onclick="mostrarVistaCombat(this)">Combat</button>
        <button class="tab-button" onclick="mostrarVistaSkills(this)">Skills</button>
        <button class="tab-button" onclick="mostrarVistaAbilities(this)">Abilities</button>
        <button class="tab-button" onclick="mostrarVistaInventory(this)">Inventory</button>
        <button class="tab-button" onclick="mostrarVistaNotes(this)">Notes</button>
        <button class="tab-button" onclick="mostrarVistaActions(this)">Actions</button>
    </div>

    <!-- Paneles de contenido de cada pestaña (ocultos hasta activarse) -->
    <div id="vistaMain" style="margin-top:20px; display:none; justify-content: center; text-align: center;">
        <div id="datosMain"></div>
    </div>
    <div id="vistaCombat" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosCombat"></div>
    </div>
    <div id="vistaSkills" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosSkills"></div>
    </div>
    <div id="vistaAbilities" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosAbilities"></div>
    </div>
    <div id="vistaInventory" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosInventory"></div>
    </div>
    <div id="vistaNotes" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosNotes"></div>
    </div>
    <div id="vistaActions" style="margin-top: 20px; display: none; text-align: center;">
        <div id="datosActions"></div>
    </div>

    <script>
        // Variable global que guarda el XML cargado
        let xmlDocGlobal = null;

        // Al cargar la página, habilita clic sobre el nombre de archivo para reload
        document.addEventListener("DOMContentLoaded", () => {
            const nombreDiv = document.getElementById("nombreArchivoXML");
            nombreDiv.style.cursor = "pointer";
            nombreDiv.title = "Haz clic para limpiar la pantalla";
            nombreDiv.style.color = 'blue';
            nombreDiv.addEventListener("click", () => {
                if (confirm("¿Deseas limpiar pantalla?")) {
                    location.reload();
                }
            });
        });

        /**
         * importarXML()
         * - Abre un FileReader para leer el XML
         * - Parsealo a DOM y lo guarda en xmlDocGlobal
         * - Muestra el nombre del archivo cargado
         * - Hace visible el panel de pestañas y llama a mostrarVistaMain()
         */
        function importarXML() {
            const input = document.getElementById("fileInput");
            const file = input.files[0];
            if (!file) return;
            const fr = new FileReader();
            fr.onload = e => {
                console.log("[LOG] carga: " + file.name);
                xmlDocGlobal = new DOMParser().parseFromString(e.target.result, "application/xml");
                limpiarEspaciosXML();
                document.getElementById("nombreArchivoXML").textContent = file.name;
                document.getElementById("tabPanel").style.display = "block";
                // Muestra la pestaña Main por defecto
                mostrarVistaMain(document.querySelector(".tab-button"));
            };
            fr.readAsText(file);
        }

        /**
         * exportarXML()
         * - Serializa xmlDocGlobal a texto
         * - Crea un Blob y fuerza la descarga como personaje.xml
         */
        function exportarXML() {
            if (!xmlDocGlobal) { alert("No hay XML cargado."); return; }
            const xml = new XMLSerializer().serializeToString(xmlDocGlobal);
            const blob = new Blob([xml], { type: "application/xml" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "personaje.xml";
            a.click();
            URL.revokeObjectURL(a.href);
        }

        /**
         * activarPestanaActiva(btn)
         * - Quita la clase .active de todas las pestañas
         * - Añade .active a la que se clicó
         */
        function activarPestanaActiva(btn) {
            document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
            if (btn) btn.classList.add("active");
        }

        /**
         * cambiarVisibilidad(panelVisible)
         * - Muestra únicamente el panel cuyo id coincide y oculta los demás
         */
        function cambiarVisibilidad(panelVisible) {
            const paneles = [
                "vistaMain",
                "vistaCombat",
                "vistaSkills",
                "vistaAbilities",
                "vistaInventory",
                "vistaNotes",
                "vistaActions"
            ];

            paneles.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;                  // si no existe, lo ignoro
                el.style.display = (id === panelVisible) ? "block" : "none";
            });
        }

        /**
         * mostrarVistaMain(btn)
         * - Construye dinámicamente los campos de la pestaña Main
         * - Usa crearCampo() para cada dato de personaje (nombre, edad, stats, etc.)
         * - Para stats: recalcula el mod y refresca al cambiar score o damage
         * - Finalmente muestra el panel y oculta los demás
         */
        function mostrarVistaMain(btn) {
            if (!xmlDocGlobal) return;
            activarPestanaActiva(btn);

            const container = document.getElementById("datosMain");
            container.innerHTML = "";

            // Wrapper principal con layout flexbox
            const w = document.createElement("div");
            w.style = 'display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;';

            // Columna izquierda: datos básicos
            const left = document.createElement("div");
            left.style = "flex:1; min-width:200px; max-width:220px;";
            [
                ["Nombre", "character > name"],
                ["Género", "character > gender"],
                ["Edad", "character > age"],
                ["Altura", "character > height"],
                ["Peso", "character > weight"],
                ["Tamaño", "character > size"],
                ["Alineación", "character > alignment"],
                ["Deidad", "character > deity"],
                ["Raza", "character > race"],
                ["Clase", "character > classes > id-00001 > name"],
                ["Nivel", "character > classes > id-00001 > level"],
                ["Damage Reduction", "character > defenses > damagereduction"],
                ["Resistances", "character > defenses > resistances"],
                ["Immunities", "character > defenses > immunities"],
                ["Special Qualities", "character > defenses > specialqualities"],
                ["Sentidos", "character > senses"]
            ].forEach(([lbl, path]) => {
                const campo = crearCampo(lbl, path);
                if (campo) left.appendChild(campo);
            });

            // Columna central: atributos y saves, AC, initiative, etc.
            const center = document.createElement("div");
            center.style = "flex:1; min-width:200px; max-width:220px;";

            // Estadísticas de habilidad
            ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"].forEach(stat => {
                const st = xmlDocGlobal.querySelector(`character > abilities > ${stat}`);
                if (!st) return;
                const scoreNode = st.querySelector("score");
                const dmgNode = st.querySelector("damage");
                const bonusNode = st.querySelector("bonus");

                const s = parseInt(scoreNode?.textContent || "0");
                const dmg = parseInt(dmgNode?.textContent || "0");
                const mod = Math.floor((s - dmg - 10) / 2);

                const wrapper = document.createElement("div");
                wrapper.style = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 12px;";

                // Label del stat (STR, DEX…)
                const label = document.createElement("label");
                label.innerHTML = `<b>${stat.substr(0, 3).toUpperCase()}</b>`;
                wrapper.appendChild(label);

                // Grid de Score / MOD / DMG
                const grid = document.createElement("div");
                grid.style = "display: grid; grid-template-columns: 50px 50px 50px; gap: 6px; text-align: center; font-size: 12px;";
                grid.innerHTML = `<div>Score</div><div>MOD</div><div>DMG</div>`;

                // Input Score
                const score = document.createElement("input");
                score.type = "number";
                score.value = s;
                score.style = "width: 50px;";
                score.onchange = () => {
                    if (scoreNode) scoreNode.textContent = score.value;
                    recalcularMod();
                };

                // Input DMG
                const dmgInput = document.createElement("input");
                dmgInput.type = "number";
                dmgInput.value = dmg;
                dmgInput.style = "width: 50px;";
                dmgInput.onchange = () => {
                    if (dmgNode) dmgNode.textContent = dmgInput.value;
                    if (scoreNode) scoreNode.textContent = score.value;
                    recalcularMod();
                };

                // Span MOD read-only
                const modSpan = document.createElement("div");
                modSpan.style = "line-height: 24px;";

                // Función para recalcular el MOD y actualizar el XML
                function recalcularMod() {
                    const sVal = parseInt(score.value || "0");
                    const dmgVal = parseInt(dmgInput.value || "0");
                    const modVal = Math.floor((sVal - dmgVal - 10) / 2);
                    modSpan.textContent = `${modVal >= 0 ? "+" : ""}${modVal}`;
                    if (bonusNode) bonusNode.textContent = modVal;
                    if (scoreNode) scoreNode.textContent = sVal;
                    if (dmgNode) dmgNode.textContent = dmgVal;
                }
                recalcularMod();

                grid.append(score, modSpan, dmgInput);
                wrapper.appendChild(grid);
                center.appendChild(wrapper);
            });

            // Otros campos centrales (AC, saves, speed…)
            [
                ["Init", "character > initiative > total"],
                ["AC", "character > ac > totals > general"],
                ["FF", "character > ac > totals > flatfooted"],
                ["Tch", "character > ac > totals > touch"],
                ["CMD", "character > ac > totals > cmd"],
                ["Fort", "character > saves > fortitude > total"],
                ["Ref", "character > saves > reflex > total"],
                ["Will", "character > saves > will > total"],
                ["SR", "character > defenses > sr > total"],
                ["Speed", "character > speed > total"],
                ["Special Movement", "character > speed > special"]
            ].forEach(([lbl, path]) => {
                const campo = crearCampo(lbl, path, "200px");
                if (campo) center.appendChild(campo);
            });

            // Columna derecha: HP, BAB y ataques
            const right = document.createElement("div");
            right.style = "flex:1; min-width:200px; max-width:220px;";
            [
                ["Current HP", "character > hp > total"],
                ["HP Actual", "character > hp > current"],
                ["Temp HP", "character > hp > temporary"],
                ["Wounds", "character > hp > wounds"],
                ["Subdual", "character > hp > nonlethal"],
                ["BAB", "character > attackbonus > base"],
                ["Melee", "character > attackbonus > melee > total"],
                ["Ranged", "character > attackbonus > ranged > total"],
                ["CMB", "character > attackbonus > grapple > total"]
            ].forEach(([lbl, path]) => {
                const campo = crearCampo(lbl, path);
                if (campo) right.appendChild(campo);
            });

            // Campo de Notas multilinea
            const notasNode = xmlDocGlobal.querySelector("character > notes_main");
            if (notasNode) {
                const cont = document.createElement("div");
                cont.style = "display: flex; flex-direction: column; align-items: flex-start; margin-top: 12px;";
                const lbl = document.createElement("label");
                lbl.textContent = "Notas";
                lbl.style = "font-weight: bold;";
                const ta = document.createElement("textarea");
                ta.rows = 3;
                ta.style = "width: 100%;";
                ta.value = notasNode.textContent.trim();
                ta.oninput = () => { notasNode.textContent = ta.value; };
                cont.append(lbl, ta);
                right.appendChild(cont);
            }

            // Montar columnas en el wrapper y mostrar
            w.append(left, center, right);
            container.appendChild(w);
            cambiarVisibilidad("vistaMain");
        }

        /**
         * mostrarVistaCombat(btn)
         * - Monta los bloques de suma (AC, saves, BAB…) llamando a crearGrupoSuma()
         */
        function mostrarVistaCombat(btn) {
            if (!xmlDocGlobal) return;
            activarPestanaActiva(btn);

            const container = document.getElementById("datosCombat");
            container.innerHTML = "";

            // Wrapper de 3 columnas
            const w = document.createElement("div");
            w.style = 'display: flex; justify-content: center; gap: 50px; flex-wrap: wrap;';
            const [left, center, right] = [0, 1, 2].map(_ => {
                const col = document.createElement("div");
                col.style = "flex:1; min-width:220px; max-width:260px;";
                return col;
            });

            // -----------------------------------------------------------------------------
            // COLUMNA IZQUIERDA (left): todos los bloques de AC y CMD
            // -----------------------------------------------------------------------------

            // 1) “AC” (Armor Class) – muestra el total de AC y el desglose en:
            //    Armor, Shield, Stat (modificador de Destreza), Size, Natural Armor, Deflection,
            //    Dodge y Misc.
            //    El parámetro dividirDesde = 4 indica que tras los primeros 4 componentes
            //    creamos un segundo grid para evitar que quede muy estrecho.
            // -----------------------------------------------------------------------------
            left.appendChild(
                crearGrupoSuma(
                    "AC",                                          // Título del bloque
                    "character > ac > totals > general",          // Path al nodo XML del total
                    [
                        ["Armor", "character > ac > sources > armor"],
                        ["Shield", "character > ac > sources > shield"],
                        ["Stat", "character > ac > sources > abilitymod"],
                        ["Size", "character > ac > sources > size"],
                        ["Nat", "character > ac > sources > naturalarmor"],
                        ["Def", "character > ac > sources > deflection"],
                        ["Dodge", "character > ac > sources > dodge"],
                        ["Misc", "character > ac > sources > misc"]
                    ],
                    4  // número de inputs antes de “dividir” en dos filas
                )
            );

            // 2) “Flat-Footed AC” – AC cuando estás desprevenido (flat-footed).
            //    Total en character > ac > totals > flatfooted, desglosado en Armor,
            //    Shield, Size y el campo específico ffmisc.
            // -----------------------------------------------------------------------------
            left.appendChild(
                crearGrupoSuma(
                    "Flat-Footed AC",
                    "character > ac > totals > flatfooted",
                    [
                        ["Armor", "character > ac > sources > armor"],
                        ["Shield", "character > ac > sources > shield"],
                        ["Size", "character > ac > sources > size"],
                        ["Misc", "character > ac > sources > ffmisc"]
                    ]
                )
            );

            // 3) “Touch AC” – AC de toque (ignora Armor y Natural), desglosado en:
            //    Stat, Size y touchmisc.
            // -----------------------------------------------------------------------------
            left.appendChild(
                crearGrupoSuma(
                    "Touch AC",
                    "character > ac > totals > touch",
                    [
                        ["Stat", "character > ac > sources > abilitymod"],
                        ["Size", "character > ac > sources > size"],
                        ["Misc", "character > ac > sources > touchmisc"]
                    ]
                )
            );

            // 4) “CMD” (Combat Maneuver Defense) – muestra CMD total y su desglose en
            //    BAB, Stat (modificador de Fuerza o Destreza), Size (cmdbasemod) y misc.
            // -----------------------------------------------------------------------------
            left.appendChild(
                crearGrupoSuma(
                    "CMD",
                    "character > ac > totals > cmd",
                    [
                        ["BAB", "character > attackbonus > base"],
                        ["Stat", "character > ac > sources > cmdabilitymod"],
                        ["Size", "character > ac > sources > cmdbasemod"],
                        ["Misc", "character > ac > sources > cmdmisc"]
                    ]
                )
            );


            // -----------------------------------------------------------------------------
            // COLUMNA CENTRAL (center): todos los bloques de salvaciones
            // -----------------------------------------------------------------------------

            // 5) “Fortitude” – Salvación de Fortaleza (Fort), desglosada en Class,
            //    Stat y Misc.
            // -----------------------------------------------------------------------------
            center.appendChild(
                crearGrupoSuma(
                    "Fortitude",
                    "character > saves > fortitude > total",
                    [
                        ["Class", "character > saves > fortitude > base"],
                        ["Stat", "character > saves > fortitude > abilitymod"],
                        ["Misc", "character > saves > fortitude > misc"]
                    ]
                )
            );

            // 6) “Reflex” – Salvación de Reflejos (Reflex), con Class, Stat y Misc.
            // -----------------------------------------------------------------------------
            center.appendChild(
                crearGrupoSuma(
                    "Reflex",
                    "character > saves > reflex > total",
                    [
                        ["Class", "character > saves > reflex > base"],
                        ["Stat", "character > saves > reflex > abilitymod"],
                        ["Misc", "character > saves > reflex > misc"]
                    ]
                )
            );

            // 7) “Will” – Salvación de Voluntad (Will), con Class, Stat y Misc.
            // -----------------------------------------------------------------------------
            center.appendChild(
                crearGrupoSuma(
                    "Will",
                    "character > saves > will > total",
                    [
                        ["Class", "character > saves > will > base"],
                        ["Stat", "character > saves > will > abilitymod"],
                        ["Misc", "character > saves > will > misc"]
                    ]
                )
            );


            // -----------------------------------------------------------------------------
            // COLUMNA DERECHA (right): SR, Speed, Initiative, BAB y Attack Bonuses
            // -----------------------------------------------------------------------------

            // 8) “SR” – Spell Resistance, con Base y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "SR",
                    "character > defenses > sr > total",
                    [
                        ["Base", "character > defenses > sr > base"],
                        ["Misc", "character > defenses > sr > misc"]
                    ]
                )
            );

            // 9) “Speed” – Velocidad, total y desglose en Base, Armor y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "Speed",
                    "character > speed > total",
                    [
                        ["Base", "character > speed > base"],
                        ["Armor", "character > speed > armor"],
                        ["Misc", "character > speed > misc"]
                    ]
                )
            );

            // 10) “Initiative” – Iniciativa, total y desglose en Stat y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "Initiative",
                    "character > initiative > total",
                    [
                        ["Stat", "character > initiative > abilitymod"],
                        ["Misc", "character > initiative > misc"]
                    ]
                )
            );

            // 11) “BAB” – Base Attack Bonus (sin desglose adicional).
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "BAB",
                    "character > attackbonus > base",
                    []
                )
            );

            // 12) “Melee” – Attack Bonus cuerpo a cuerpo, total y desglose en Stat, Size y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "Melee",
                    "character > attackbonus > melee > total",
                    [
                        ["Stat", "character > attackbonus > melee > abilitymod"],
                        ["Size", "character > attackbonus > melee > size"],
                        ["Misc", "character > attackbonus > melee > misc"]
                    ]
                )
            );

            // 13) “Ranged” – Attack Bonus a distancia, total y desglose en Stat, Size y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "Ranged",
                    "character > attackbonus > ranged > total",
                    [
                        ["Stat", "character > attackbonus > ranged > abilitymod"],
                        ["Size", "character > attackbonus > ranged > size"],
                        ["Misc", "character > attackbonus > ranged > misc"]
                    ]
                )
            );

            // 14) “CMB” – Combat Maneuver Bonus, total y desglose en Stat, Size y Misc.
            // -----------------------------------------------------------------------------
            right.appendChild(
                crearGrupoSuma(
                    "CMB",
                    "character > attackbonus > grapple > total",
                    [
                        ["Stat", "character > attackbonus > grapple > abilitymod"],
                        ["Size", "character > attackbonus > grapple > size"],
                        ["Misc", "character > attackbonus > grapple > misc"]
                    ]
                )
            );

            // Ensambla columnas y muestra
            w.append(left, center, right);
            container.appendChild(w);
            cambiarVisibilidad("vistaCombat");
        }

        /**
         * mostrarVistaSkills(btn)
         * - Marca la pestaña Skills como activa
         * - Oculta todos los paneles y muestra solo #vistaSkills
         * - Rellena dinámicamente #datosSkills con una tabla de:
         *     Habilidad, Ranks, Stat, Misc, Total
         * @param {HTMLElement} btn — el botón de pestaña clicado
         */
        function mostrarVistaSkills(btn) {
            if (!xmlDocGlobal) return;

            // 1) Marca la pestaña activa
            activarPestanaActiva(btn);

            // 2) Limpia y rellena #datosSkills
            const datos = document.getElementById('datosSkills');
            datos.innerHTML = '';

            const skills = xmlDocGlobal.querySelectorAll('character > skilllist > *');
            if (skills.length === 0) {
                datos.innerHTML = '<p>No se encontraron habilidades en el XML.</p>';
                return;
            }

            const tabla = document.createElement('table');
            tabla.style.margin = '0 auto';
            tabla.innerHTML = `
                <tr>
                    <th>Habilidad</th>
                    <th>Ranks</th>
                    <th>Stat</th>
                    <th>Misc</th>
                    <th>Total</th>
                </tr>
            `;

            skills.forEach(skillNode => {
                const fila = document.createElement('tr');
                // Obtén el label y sublabel si existe
                const label = skillNode.querySelector('label')?.textContent || skillNode.nodeName;
                const sublabel = skillNode.querySelector('sublabel')?.textContent;
                const nombre = sublabel ? `${label} (${sublabel})` : label;
                fila.appendChild(Object.assign(document.createElement('td'), { textContent: nombre }));

                // --- Inputs editables ---
                // Ranks
                const ranksNode = skillNode.querySelector('ranks');
                const ranksCell = document.createElement('td');
                const ranksInput = document.createElement('input');
                ranksInput.type = 'number';
                ranksInput.style.width = '60px';
                ranksInput.value = ranksNode?.textContent.trim() || "0";
                ranksCell.appendChild(ranksInput);
                fila.appendChild(ranksCell);

                // Stat
                const statNode = skillNode.querySelector('stat');
                const statCell = document.createElement('td');
                const statInput = document.createElement('input');
                statInput.type = 'number';
                statInput.style.width = '60px';
                statInput.value = statNode?.textContent.trim() || "0";
                statCell.appendChild(statInput);
                fila.appendChild(statCell);

                // Misc
                const miscNode = skillNode.querySelector('misc');
                const miscCell = document.createElement('td');
                const miscInput = document.createElement('input');
                miscInput.type = 'number';
                miscInput.style.width = '60px';
                miscInput.value = miscNode?.textContent.trim() || "0";
                miscCell.appendChild(miscInput);
                fila.appendChild(miscCell);

                // Total (readonly, suma automática)
                const totalNode = skillNode.querySelector('total');
                const totalCell = document.createElement('td');
                const totalInput = document.createElement('input');
                totalInput.type = 'number';
                totalInput.style.width = '60px';
                totalInput.readOnly = true;
                // Función para recalcular el total
                function recalcularTotal() {
                    const suma =
                        parseInt(ranksInput.value || "0") +
                        parseInt(statInput.value || "0") +
                        parseInt(miscInput.value || "0");
                    totalInput.value = suma;
                    if (totalNode) totalNode.textContent = suma;
                }
                // Inicializa el valor
                recalcularTotal();
                // Al cambiar cualquier input, recalcula
                ranksInput.oninput = () => { if (ranksNode) ranksNode.textContent = ranksInput.value; recalcularTotal(); };
                statInput.oninput = () => { if (statNode) statNode.textContent = statInput.value; recalcularTotal(); };
                miscInput.oninput = () => { if (miscNode) miscNode.textContent = miscInput.value; recalcularTotal(); };
                totalCell.appendChild(totalInput);
                fila.appendChild(totalCell);

                tabla.appendChild(fila);
            });

            datos.appendChild(tabla);
            cambiarVisibilidad('vistaSkills');
        }

        /**
         * mostrarVistaAbilities(btn)
         * - Activa la pestaña activa según el botón pulsado.
         * - Limpia el contenedor de datosAbilities.
         * - Define grupos de datos (Feats, Class Abilities, Racial Traits, Proficiencies) con título, ruta en el XML y campos a mostrar.
         * - Para cada grupo:
         *     • Crea un wrapper con estilo y añade el título.
         *     • Busca el nodo base en xmlDocGlobal; si no existe, muestra "No data.".
         *     • Para cada elemento hijo directo:
         *         – Crea una tarjeta con estilo.
         *         – Añade botón de eliminar que quita el nodo y refresca la vista.
         *         – Por cada campo definido:
         *             · Si existe y no está vacío, añade etiqueta con nombre capitalizado.
         *             · Si el nodo es formattedtext, renderiza innerHTML; si no, textContent.
         *         – Añade la tarjeta al wrapper.
         *     • Añade el wrapper al contenedor.
         * - Llama a cambiarVisibilidad("vistaAbilities") para mostrar esta vista.
         */
        function mostrarVistaAbilities(btn) {
            activarPestanaActiva(btn);
            const container = document.getElementById("datosAbilities");
            container.innerHTML = "";

            const grupos = [
                {
                    titulo: "Feats",
                    path: "character > featlist",
                    campos: ["name", "benefit", "prerequisites", "special", "summary"]
                },
                {
                    titulo: "Class Abilities",
                    path: "character > specialabilitylist",
                    campos: ["name", "text", "type"]
                },
                {
                    titulo: "Racial Traits",
                    path: "character > traitlist",
                    campos: ["name", "text", "type"]
                },
                {
                    titulo: "Proficiencies",
                    path: "character > proficiencylist",
                    campos: ["name", "text"]
                }
            ];

            grupos.forEach(grupo => {
                const wrapper = document.createElement("div");
                wrapper.style = "margin-bottom: 32px; border:1px solid #ccc; border-radius:8px; padding:12px; background:#e9e9e9; max-width:600px; margin:auto;";

                // Título del grupo
                const titulo = document.createElement("h3");
                titulo.textContent = grupo.titulo;
                wrapper.appendChild(titulo);

                // Lista de nodos hijos
                const base = xmlDocGlobal.querySelector(grupo.path);
                if (!base) {
                    wrapper.appendChild(document.createTextNode("No data."));
                    container.appendChild(wrapper);
                    return;
                }

                // Mostrar cada entrada
                base.querySelectorAll(":scope > *").forEach(nodo => {
                    const card = document.createElement("div");
                    card.style = "border:1px solid #ddd; border-radius:6px; margin:8px 0; padding:8px; background:#fff; position:relative;";

                    // Botón eliminar
                    const btnDel = document.createElement("button");
                    btnDel.textContent = "✖";
                    btnDel.title = "Eliminar";
                    btnDel.style = "position:absolute; right:8px; top:8px; background:#f44; color:#fff; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer;";
                    btnDel.onclick = () => {
                        nodo.parentNode.removeChild(nodo);
                        mostrarVistaAbilities(btn); // refresca la vista
                    };
                    card.appendChild(btnDel);

                    // --- ESTE BLOQUE DEBE IR AQUÍ ---
                    grupo.campos.forEach(campo => {
                        const n = nodo.querySelector(campo);
                        if (!n) return;

                        // Label
                        const label = document.createElement("div");
                        label.style = "font-weight:bold; margin-top:4px;";
                        label.textContent = campo.charAt(0).toUpperCase() + campo.slice(1) + ":";
                        card.appendChild(label);

                        // Editable input para name, type, summary, prerequisites, etc.
                        if (["name", "type", "summary", "prerequisites"].includes(campo)) {
                            const inp = document.createElement("input");
                            inp.type = "text";
                            inp.value = (n.textContent || "").trim();
                            inp.style = "width:95%; margin-bottom:4px;";
                            inp.oninput = () => { n.textContent = inp.value.trim(); };
                            card.appendChild(inp);
                        }
                        // Editable textarea para benefit, special, text (formattedtext)
                        else if (["benefit", "special", "text"].includes(campo)) {
                            const textarea = document.createElement("textarea");
                            textarea.value = ((n.getAttribute("type") === "formattedtext" ? n.innerHTML : n.textContent) || "").trim();
                            textarea.style = "width:95%; min-height:60px; margin-bottom:4px;";
                            textarea.oninput = () => {
                                const val = textarea.value.trim();
                                if (n.getAttribute("type") === "formattedtext") {
                                    n.innerHTML = val;
                                } else {
                                    n.textContent = val;
                                }
                            };
                            card.appendChild(textarea);
                        }
                        // Solo mostrar como texto si no es editable
                        else {
                            const val = document.createElement("div");
                            val.textContent = (n.textContent || "").trim();
                            val.style = "margin-left:8px; margin-bottom:4px;";
                            card.appendChild(val);
                        }
                    });
                    // --- FIN DEL BLOQUE ---

                    wrapper.appendChild(card);
                });

                container.appendChild(wrapper);
            });

            cambiarVisibilidad("vistaAbilities");
        }

        /**
         * mostrarVistaInventory(btn)
         * - Activa la pestaña activa según el botón pulsado.
         * - Limpia el contenedor datosInventory.
         * - Sección “Items del Inventario”:
         *     • Crea wrapper con estilo y título.
         *     • Si no hay items, muestra mensaje.
         *     • Para cada item:
         *         – Crea tarjeta con estilo.
         *         – Añade botón eliminar que remueve el nodo y refresca la vista.
         *         – Añade inputs editables para count, name, location, carried, weight, sincronizando XML oninput.
         *     • Añade wrapper al contenedor.
         * - Sección “Tesoro (Gold)”:
         *     • Crea wrapper con estilo y título.
         *     • Para total, spent, carried:
         *         – Añade label e input number sincronizando XML oninput.
         *     • Añade wrapper al contenedor.
         * - Sección “Carga y Límites de Peso”:
         *     • Crea wrapper con estilo y título.
         *     • Para encumbrancetotal, maxloadlight, maxloadmedium, maxloadheavy, liftoverhead, liftground, drag:
         *         – Añade label e input number sincronizando XML oninput.
         *     • Añade wrapper al contenedor.
         * - Llama a cambiarVisibilidad("vistaInventory") para mostrar esta vista.
         */
        function mostrarVistaInventory(btn) {
            activarPestanaActiva(btn);
            const container = document.getElementById("datosInventory");
            container.innerHTML = "";

            // --- ITEMS DEL INVENTARIO ---
            const invWrapper = document.createElement("div");
            invWrapper.style = "margin-bottom:32px; border:1px solid #ccc; border-radius:8px; padding:12px; background:#e9e9e9; max-width:700px; margin:auto;";

            const invTitle = document.createElement("h3");
            invTitle.textContent = "Items del Inventario";
            invWrapper.appendChild(invTitle);

            const invList = xmlDocGlobal?.querySelector("character > inventorylist");
            if (!invList || invList.children.length === 0) {
                invWrapper.appendChild(document.createTextNode("No hay items en el inventario."));
            } else {
                Array.from(invList.children).forEach(item => {
                    const card = document.createElement("div");
                    card.style = "border:1px solid #ddd; border-radius:6px; margin:8px 0; padding:8px; background:#fff; position:relative;";

                    // Botón eliminar
                    const btnDel = document.createElement("button");
                    btnDel.textContent = "✖";
                    btnDel.title = "Eliminar";
                    btnDel.style = "position:absolute; right:8px; top:8px; background:#f44; color:#fff; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer;";
                    btnDel.onclick = () => {
                        item.parentNode.removeChild(item);
                        mostrarVistaInventory(btn);
                    };
                    card.appendChild(btnDel);

                    // Campos editables
                    [
                        ["Cantidad", "count"],
                        ["Nombre", "name"],
                        ["Ubicación", "location"],
                        ["Slot (Body Slot)", "carried"],
                        ["Peso", "weight"]
                    ].forEach(([label, tag]) => {
                        const n = item.querySelector(tag);
                        if (!n) return;
                        const lbl = document.createElement("div");
                        lbl.style = "font-weight:bold; margin-top:4px;";
                        lbl.textContent = label + ":";
                        card.appendChild(lbl);

                        const inp = document.createElement("input");
                        inp.type = (tag === "weight" || tag === "count") ? "number" : "text";
                        inp.value = (n.textContent || "").trim();
                        inp.style = "width:95%; margin-bottom:4px;";
                        inp.oninput = () => { n.textContent = inp.value.trim(); };
                        card.appendChild(inp);
                    });

                    invWrapper.appendChild(card);
                });
            }
            container.appendChild(invWrapper);

            // --- TESORO (GOLD) ---
            const goldWrapper = document.createElement("div");
            goldWrapper.style = "margin-bottom:32px; border:1px solid #ccc; border-radius:8px; padding:12px; background:#e9e9e9; max-width:700px; margin:auto;";

            const goldTitle = document.createElement("h3");
            goldTitle.textContent = "Tesoro (Gold)";
            goldWrapper.appendChild(goldTitle);

            const coin = xmlDocGlobal?.querySelector("character > coin");
            [
                ["Total", "total"],
                ["Gastado", "spent"],
                ["Restante", "carried"]
            ].forEach(([label, tag]) => {
                const n = coin?.querySelector(tag);
                if (!n) return;
                const lbl = document.createElement("div");
                lbl.style = "font-weight:bold; margin-top:4px;";
                lbl.textContent = label + ":";
                goldWrapper.appendChild(lbl);

                const inp = document.createElement("input");
                inp.type = "number";
                inp.value = (n.textContent || "").trim();
                inp.style = "width:95%; margin-bottom:4px;";
                inp.oninput = () => { n.textContent = inp.value.trim(); };
                goldWrapper.appendChild(inp);
            });
            container.appendChild(goldWrapper);

            // --- CARGA Y LÍMITES DE PESO ---
            const cargaWrapper = document.createElement("div");
            cargaWrapper.style = "margin-bottom:32px; border:1px solid #ccc; border-radius:8px; padding:12px; background:#e9e9e9; max-width:700px; margin:auto;";

            const cargaTitle = document.createElement("h3");
            cargaTitle.textContent = "Carga y Límites de Peso";
            cargaWrapper.appendChild(cargaTitle);

            const enc = xmlDocGlobal?.querySelector("character > encumbrance");
            [
                ["Carga actual", "encumbrancetotal"],
                ["Máx. carga ligera", "maxloadlight"],
                ["Máx. carga media", "maxloadmedium"],
                ["Máx. carga pesada", "maxloadheavy"],
                ["Levantar sobre cabeza", "liftoverhead"],
                ["Levantar del suelo", "liftground"],
                ["Arrastrar", "drag"]
            ].forEach(([label, tag]) => {
                const n = enc?.querySelector(tag);
                if (!n) return;
                const lbl = document.createElement("div");
                lbl.style = "font-weight:bold; margin-top:4px;";
                lbl.textContent = label + ":";
                cargaWrapper.appendChild(lbl);

                const inp = document.createElement("input");
                inp.type = "number";
                inp.value = (n.textContent || "").trim();
                inp.style = "width:95%; margin-bottom:4px;";
                inp.oninput = () => { n.textContent = inp.value.trim(); };
                cargaWrapper.appendChild(inp);
            });
            container.appendChild(cargaWrapper);

            cambiarVisibilidad("vistaInventory");
        }

        /**
         * mostrarVistaNotes(btn)
         * - Activa la pestaña activa según el botón pulsado.
         * - Limpia el contenedor datosNotes.
         * - Crea un wrapper con estilo y añade campos para Appearance, Languages y Notes.
         * - Appearance: textarea editable que actualiza el nodo XML.
         * - Languages: lista de inputs editables para cada lenguaje encontrado en el XML.
         * - Notes: textarea editable que actualiza el nodo XML.
         * - Añade todo al contenedor y llama a cambiarVisibilidad("vistaNotes") para mostrar esta vista.
         */
        function mostrarVistaNotes(btn) {
            activarPestanaActiva(btn);
            const container = document.getElementById("datosNotes");
            container.innerHTML = "";

            // Wrapper general
            const wrapper = document.createElement("div");
            wrapper.style = "display: flex; flex-wrap: wrap; gap: 24px; justify-content: center; align-items: flex-start; max-width:900px; margin:0 auto;";

            // --- Appearance ---
            const appearanceNode = xmlDocGlobal?.querySelector("character > appearance");
            const appearanceBox = document.createElement("div");
            appearanceBox.style = "flex:2; min-width:320px; max-width:480px; background:#f9f6f2; border:2px solid #bba; border-radius:10px; padding:10px; margin-bottom:12px;";
            const appearanceLabel = document.createElement("div");
            appearanceLabel.innerHTML = "<b>Appearance</b>";
            appearanceLabel.style = "text-align:center; font-size:18px; margin-bottom:4px;";
            appearanceBox.appendChild(appearanceLabel);
            const appearanceTA = document.createElement("textarea");
            appearanceTA.style = "width:100%; min-height:90px; font-size:15px; background:transparent; border:none; resize:vertical; outline:none;";
            appearanceTA.value = (appearanceNode?.textContent || "").trim();
            appearanceTA.oninput = () => { if (appearanceNode) appearanceNode.textContent = appearanceTA.value; };
            appearanceBox.appendChild(appearanceTA);

            // --- Languages ---
            const langBox = document.createElement("div");
            langBox.style = "flex:1; min-width:180px; max-width:220px; background:#f9f6f2; border:2px solid #bba; border-radius:10px; padding:10px; margin-bottom:12px;";
            const langLabel = document.createElement("div");
            langLabel.innerHTML = "<b>Languages</b>";
            langLabel.style = "text-align:center; font-size:18px; margin-bottom:4px;";
            langBox.appendChild(langLabel);

            const langList = xmlDocGlobal?.querySelectorAll("character > languagelist > *");
            if (langList && langList.length > 0) {
                langList.forEach(langNode => {
                    const nameNode = langNode.querySelector("name");
                    if (!nameNode) return;
                    const langDiv = document.createElement("div");
                    langDiv.style = "margin-bottom:4px; display:flex; align-items:center;";
                    const langInput = document.createElement("input");
                    langInput.type = "text";
                    langInput.value = (nameNode.textContent || "").trim();
                    langInput.style = "width:100%; background:transparent; border:none; border-bottom:1px solid #ccc; font-size:15px; margin-bottom:2px;";
                    langInput.oninput = () => { nameNode.textContent = langInput.value.trim(); };
                    langDiv.appendChild(langInput);
                    langBox.appendChild(langDiv);
                });
            } else {
                langBox.appendChild(document.createTextNode("No languages found."));
            }

            // --- Notes ---
            const notesNode = xmlDocGlobal?.querySelector("character > notes");
            const notesBox = document.createElement("div");
            notesBox.style = "flex-basis:100%; background:#f9f6f2; border:2px solid #bba; border-radius:10px; padding:10px; margin-bottom:12px;";
            const notesLabel = document.createElement("div");
            notesLabel.innerHTML = "<b>Notes</b>";
            notesLabel.style = "text-align:center; font-size:18px; margin-bottom:4px;";
            notesBox.appendChild(notesLabel);
            const notesTA = document.createElement("textarea");
            notesTA.style = "width:100%; min-height:120px; font-size:15px; background:transparent; border:none; resize:vertical; outline:none;";
            notesTA.value = (notesNode?.textContent || "").trim();
            notesTA.oninput = () => { if (notesNode) notesNode.textContent = notesTA.value; };
            notesBox.appendChild(notesTA);

            // Ensamblar
            wrapper.appendChild(appearanceBox);
            wrapper.appendChild(langBox);
            wrapper.appendChild(notesBox);
            container.appendChild(wrapper);

            cambiarVisibilidad("vistaNotes");
        }

        /**
         * crearGrupoSuma(label, totalPath, componentes, dividirDesde)
         * - Crea un bloque que muestra:
         *   • Un título (<b>label</b>)
         *   • Un input readonly con el Total (path = totalPath)
         *   • Inputs editables para cada componente (array de [subLabel, path])
         *   • Si dividirDesde se define, coloca componentes en 2 filas
         * - Cada vez que cambias un componente, recalcula la suma y actualiza el XML y el Total
         */
        function crearGrupoSuma(label, totalPath, componentes, dividirDesde = null) {
            const wrapper = document.createElement("div");
            wrapper.style = "margin-bottom:24px; text-align:center;";

            const lbl = document.createElement("div");
            lbl.innerHTML = `<b>${label}</b>`;
            wrapper.appendChild(lbl);

            const totalNode = xmlDocGlobal.querySelector(totalPath);

            // Inputs de componentes
            const compInputs = componentes.map(([_, path]) => {
                const node = xmlDocGlobal.querySelector(path);
                const inp = document.createElement("input");
                inp.type = "number";
                inp.style = "width:50px; text-align:center;";
                inp.value = node?.textContent.trim() || "0";
                inp.oninput = () => {
                    if (node) node.textContent = inp.value;
                    recalcularTotal();
                    actualizarTodosLosTotales();
                };
                return inp;
            });

            // Input Total (solo una vez)
            const inputTotal = document.createElement("input");
            inputTotal.type = "number";
            inputTotal.readOnly = true;
            inputTotal.style = "width:50px; text-align:center;";

            // Función para recalcular el total
            function recalcularTotal() {
                const suma = compInputs.reduce((s, i) => s + parseInt(i.value || "0"), 0);
                inputTotal.value = suma;
                if (totalNode) totalNode.textContent = suma;
            }

            function actualizarTodosLosTotales() {
                document.querySelectorAll('[data-grupo-suma]').forEach(div => {
                    if (div.recalcularTotal) div.recalcularTotal();
                });
            }

            // Divide en dos filas, pero solo un Total y un Misc
            const fila1 = document.createElement("div");
            fila1.style = "display: grid; grid-template-columns: 50px repeat(" + dividirDesde + ", 50px); gap: 6px; justify-content: center; margin-top: 4px;";
            fila1.appendChild(Object.assign(document.createElement("div"), { textContent: "Total", style: "font-size:12px;" }));
            componentes.slice(0, dividirDesde).forEach(([subLbl]) => {
                fila1.appendChild(Object.assign(document.createElement("div"), { textContent: subLbl, style: "font-size:12px;" }));
            });
            fila1.appendChild(inputTotal);
            compInputs.slice(0, dividirDesde).forEach(i => fila1.appendChild(i));
            wrapper.appendChild(fila1);

            const fila2 = document.createElement("div");
            fila2.style = "display: grid; grid-template-columns: repeat(" + (componentes.length - dividirDesde) + ", 50px); gap: 6px; justify-content: center; margin-top: 4px;";
            componentes.slice(dividirDesde).forEach(([subLbl]) => {
                fila2.appendChild(Object.assign(document.createElement("div"), { textContent: subLbl, style: "font-size:12px;" }));
            });
            compInputs.slice(dividirDesde).forEach(i => fila2.appendChild(i));
            wrapper.appendChild(fila2);

            wrapper.dataset.grupoSuma = "1";
            wrapper.recalcularTotal = recalcularTotal;
            recalcularTotal();

            return wrapper;
        }

        /**
         * crearCampo(label, path, ancho)
         * - Crea un <div> con <label> y <input>
         * - label: texto del <label>
         * - path: XPath al nodo XML donde se lee/graba value
         * - ancho: CSS width para el input
         */
        function crearCampo(label, path, ancho = "100%") {
            const node = xmlDocGlobal.querySelector(path);
            if (!node) return null;
            const contenedor = document.createElement("div");
            contenedor.style = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 8px;";
            // Etiqueta
            const lbl = document.createElement("label");
            lbl.textContent = label;
            lbl.style = "font-weight: bold; font-size: 13px; margin-bottom: 2px;";
            contenedor.appendChild(lbl);
            // Input de texto
            const input = document.createElement("input");
            input.type = "text";
            input.value = node.textContent.trim();
            input.dataset.path = path;
            input.style = `width: ${ancho};`;
            // Sincronizar cambios con el XML
            input.oninput = () => { node.textContent = input.value; };
            contenedor.appendChild(input);
            return contenedor;
        }

        /**
         * limpiarEspaciosXML()
         * - Comprueba si xmlDocGlobal existe; si no, sale sin acción.
         * - Selecciona nodos de character > featlist (type="string", name, summary, prerequisites, benefit, special),
         *   character > specialabilitylist (name, type, text),
         *   character > traitlist (name, type, text),
         *   character > proficiencylist (name, text).
         * - Para cada nodo:
         *     • Si textContent existe, aplica trim() a textContent.
         *     • Si tiene innerHTML y atributo type="formattedtext", aplica trim() a innerHTML.
         */
        function limpiarEspaciosXML() {
            if (!xmlDocGlobal) return;
            // Lista de nodos a limpiar (puedes agregar más si lo necesitas)
            const nodos = xmlDocGlobal.querySelectorAll(
                'character > featlist [type="string"], character > featlist name, character > featlist summary, character > featlist prerequisites, character > featlist benefit, character > featlist special, character > specialabilitylist name, character > specialabilitylist type, character > specialabilitylist text, character > traitlist name, character > traitlist type, character > traitlist text, character > proficiencylist name, character > proficiencylist text'
            );
            nodos.forEach(n => {
                if (n.textContent) n.textContent = n.textContent.trim();
                if (n.innerHTML && n.getAttribute("type") === "formattedtext") n.innerHTML = n.innerHTML.trim();
            });
        }

        // Pestañas aún no implementadas (alerta placeholder)
        function mostrarVistaActions(btn) { alert("Actions no implementado."); }
    </script>
</body>

</html>